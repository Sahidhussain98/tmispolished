<!DOCTYPE html>
<html>
  <head>
    <title>Program, Topic & Session Form</title>
    <!-- Include Tailwind CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <!-- <script src="/js/dummy.js" defer></script> -->
  </head>
  <div th:replace="~{testfrontend/headermainadmin :: header-navbar}"></div>

  <body class="bg-gray-100">
    <div class="container mx-auto max-w-4xl p-6">
      <form id="mainForm" class="bg-white p-6 rounded shadow">
        <!-- Program Section -->
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Program Details</h2>
        <div class="form-group mb-4">
          <label
            for="programName"
            class="block text-gray-700 font-semibold mb-2"
          >
            Program Name
          </label>
          <input
            type="text"
            id="programName"
            name="programName"
            required
            class="w-full p-2 border border-gray-300 rounded"
          />
        </div>
        <div class="form-group mb-4">
          <label
            for="programFmrCode"
            class="block text-gray-700 font-semibold mb-2"
          >
            Fmr Code
          </label>
          <input
            type="text"
            id="programFmrCode"
            name="fmrCode"
            required
            class="w-full p-2 border border-gray-300 rounded"
          />
        </div>

        <!-- Topics Section -->
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-bold text-gray-800">Topics</h2>
          <button
            type="button"
            id="addTopicBtn"
            class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 transition"
          >
            + Add Topic
          </button>
        </div>
        <div id="topicsContainer" class="space-y-6 mb-4"></div>

        <button
          type="submit"
          class="w-full bg-green-500 text-white py-2 rounded hover:bg-green-600 transition"
        >
          Save All
        </button>
      </form>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const topicsContainer = document.getElementById("topicsContainer");
        const addTopicBtn = document.getElementById("addTopicBtn");
        const mainForm = document.getElementById("mainForm");

        // ðŸ“Œ Add Topic
        addTopicBtn.addEventListener("click", () => {
          const topicIndex = topicsContainer.children.length;
          const topicDiv = document.createElement("div");
          // Add a unique class "topic-container" so that only these elements are processed on form submission.
          topicDiv.classList.add(
            "form-group",
            "topic-container",
            "p-4",
            "bg-gray-50",
            "border",
            "border-gray-200",
            "rounded"
          );
          topicDiv.innerHTML = `
            <h3 class="text-xl font-semibold text-gray-800 mb-2">Topic</h3>
            <div class="mb-2">
              <label class="block text-gray-700 font-medium">Topic Name</label>
              <input type="text" name="topics[${topicIndex}][topicName]" required class="w-full p-2 border border-gray-300 rounded">
            </div>
            <div class="mb-2">
              <label class="block text-gray-700 font-medium">Fmr Code</label>
              <input type="text" name="topics[${topicIndex}][fmrCode]" required class="w-full p-2 border border-gray-300 rounded">
            </div>
            <div class="mb-2">
              <label class="block text-gray-700 font-medium">Description</label>
              <input type="text" name="topics[${topicIndex}][topicDescription]" required class="w-full p-2 border border-gray-300 rounded">
            </div>
            <button type="button" class="remove-topic-btn bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition mb-2">
              Remove Topic
            </button>
            <h4 class="text-lg font-semibold text-gray-800 mt-4 mb-2">Sessions</h4>
            <div id="sessionsContainer-${topicIndex}" class="space-y-4 mb-2"></div>
            <button type="button" class="addSessionBtn bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 transition" data-topic-index="${topicIndex}">
              + Add Session
            </button>
          `;

          topicsContainer.appendChild(topicDiv);

          // Remove topic handler
          topicDiv
            .querySelector(".remove-topic-btn")
            .addEventListener("click", () => topicDiv.remove());

          // Add session handler for this topic
          topicDiv
            .querySelector(".addSessionBtn")
            .addEventListener("click", (event) => {
              const topicIndex = event.target.getAttribute("data-topic-index");
              const sessionsContainer = document.getElementById(
                `sessionsContainer-${topicIndex}`
              );

              const sessionDiv = document.createElement("div");
              sessionDiv.classList.add(
                "form-group",
                "flex",
                "items-center",
                "space-x-2"
              );
              sessionDiv.innerHTML = `
                <div class="flex-1">
                  <label class="block text-gray-700 font-medium">Session Name</label>
                  <input type="text" name="topics[${topicIndex}][sessions][]" required class="w-full p-2 border border-gray-300 rounded">
                </div>
                <button type="button" class="remove-session-btn bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition self-end">
                  Remove
                </button>
              `;

              sessionsContainer.appendChild(sessionDiv);
              sessionDiv
                .querySelector(".remove-session-btn")
                .addEventListener("click", () => sessionDiv.remove());
            });
        });

        // ðŸ“Œ Submit Form Data
        mainForm.addEventListener("submit", (event) => {
          event.preventDefault();

          const payload = {
            programName: document.getElementById("programName").value,
            fmrcode: document.getElementById("programFmrCode").value,
            topics: [],
          };

          // Iterate only over topic containers
          document
            .querySelectorAll("#topicsContainer .topic-container")
            .forEach((topicDiv, topicIndex) => {
              const topic = {
                topicName: topicDiv.querySelector(
                  `input[name="topics[${topicIndex}][topicName]"]`
                ).value,
                fmrCode: topicDiv.querySelector(
                  `input[name="topics[${topicIndex}][fmrCode]"]`
                ).value,
                topicDescription: topicDiv.querySelector(
                  `input[name="topics[${topicIndex}][topicDescription]"]`
                ).value,
                sessions: [],
              };

              topicDiv
                .querySelectorAll(`#sessionsContainer-${topicIndex} input`)
                .forEach((sessionInput) => {
                  topic.sessions.push({ sessionName: sessionInput.value });
                });

              payload.topics.push(topic);
            });

          console.log(JSON.stringify(payload));

          fetch("/api/programs/saveProgramWithTopicsAndSessions", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          })
            .then((response) => response.json())
            .then((data) => {
              alert("Program, Topics, and Sessions saved successfully!");
            })
            .catch((error) => {
              console.error("Error:", error);
              alert("Error saving data!");
            });
        });
      });
    </script>
  </body>
</html>
