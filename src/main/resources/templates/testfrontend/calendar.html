<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calendar Management</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-gray-100">
    <div th:replace="~{testfrontend/headermainadmin :: header-navbar}"></div>
    <!-- Main Content -->
    <main class="container mx-auto p-6">
      <div class="bg-white p-6 rounded-lg shadow">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">
          Calendar Management
        </h1>

        <!-- Create Calendar Section -->
        <div class="mb-6">
          <button
            id="showCreateFormBtn"
            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition mb-4"
          >
            Create Calendar
          </button>
          <div id="createForm" class="hidden bg-gray-50 p-4 rounded">
            <h3 class="text-xl font-semibold text-gray-700 mb-3">
              Create Calendar
            </h3>
            <input
              type="text"
              id="createTopic"
              placeholder="Topic"
              class="w-full p-2 border border-gray-300 rounded mb-3"
            />
            <input
              type="number"
              id="createTarget"
              placeholder="Target"
              class="w-full p-2 border border-gray-300 rounded mb-3"
            />
            <input
              type="datetime-local"
              id="createStartDate"
              placeholder="Start Date"
              class="w-full p-2 border border-gray-300 rounded mb-3"
            />
            <input
              type="datetime-local"
              id="createEndDate"
              placeholder="End Date"
              class="w-full p-2 border border-gray-300 rounded mb-3"
            />
            <input
              type="number"
              id="createDuration"
              placeholder="Duration"
              class="w-full p-2 border border-gray-300 rounded mb-3"
            />

            <label for="createProgram" class="block text-gray-700 mb-1"
              >Select Program:</label
            >
            <select
              id="createProgram"
              class="w-full p-2 border border-gray-300 rounded mb-3"
            ></select>

            <label for="createNatureOfStaff" class="block text-gray-700 mb-1"
              >Select Nature of Staff:</label
            >
            <select
              id="createNatureOfStaff"
              class="w-full p-2 border border-gray-300 rounded mb-3"
            ></select>

            <label for="createVenue" class="block text-gray-700 mb-1"
              >Select Venue:</label
            >
            <select
              id="createVenue"
              class="w-full p-2 border border-gray-300 rounded mb-3"
            ></select>

            <div class="flex space-x-3">
              <button
                id="createCalendarBtn"
                class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition"
              >
                Create
              </button>
              <button
                id="cancelCreateFormBtn"
                class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition"
              >
                Cancel
              </button>
            </div>
          </div>
        </div>

        <!-- Calendar List Section -->
        <div id="calendarListContainer">
          <h3 class="text-2xl font-semibold text-gray-800 mb-4">
            All Calendars
          </h3>
          <div id="calendarList" class="space-y-4">
            <!-- Calendar items will be injected here -->
          </div>
        </div>

        <!-- Update Calendar Section -->
        <div id="updateForm" class="hidden bg-gray-50 p-4 rounded mt-6">
          <h3 class="text-xl font-semibold text-gray-700 mb-3">
            Update Calendar
          </h3>
          <input type="hidden" id="updateCalendarId" />
          <input
            type="text"
            id="updateTopic"
            placeholder="Topic"
            class="w-full p-2 border border-gray-300 rounded mb-3"
          />
          <input
            type="number"
            id="updateTarget"
            placeholder="Target"
            class="w-full p-2 border border-gray-300 rounded mb-3"
          />
          <input
            type="datetime-local"
            id="updateStartDate"
            placeholder="Start Date"
            class="w-full p-2 border border-gray-300 rounded mb-3"
          />
          <input
            type="datetime-local"
            id="updateEndDate"
            placeholder="End Date"
            class="w-full p-2 border border-gray-300 rounded mb-3"
          />
          <input
            type="number"
            id="updateDuration"
            placeholder="Duration"
            class="w-full p-2 border border-gray-300 rounded mb-3"
          />

          <label for="updateProgram" class="block text-gray-700 mb-1"
            >Select Program:</label
          >
          <select
            id="updateProgram"
            class="w-full p-2 border border-gray-300 rounded mb-3"
          ></select>

          <label for="updateNatureOfStaff" class="block text-gray-700 mb-1"
            >Select Nature of Staff:</label
          >
          <select
            id="updateNatureOfStaff"
            class="w-full p-2 border border-gray-300 rounded mb-3"
          ></select>

          <label for="updateVenue" class="block text-gray-700 mb-1"
            >Select Venue:</label
          >
          <select
            id="updateVenue"
            class="w-full p-2 border border-gray-300 rounded mb-3"
          ></select>

          <div class="flex space-x-3">
            <button
              id="updateCalendarBtn"
              class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600 transition"
            >
              Update
            </button>
            <button
              id="cancelUpdateFormBtn"
              class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>
    </main>

    <script>
      const calendarList = document.getElementById("calendarList");
      const showCreateFormBtn = document.getElementById("showCreateFormBtn");
      const createForm = document.getElementById("createForm");
      const updateForm = document.getElementById("updateForm");

      // Toggle Create Form visibility
      showCreateFormBtn.addEventListener("click", () => {
        createForm.classList.toggle("hidden");
      });

      // Cancel Create Form
      document
        .getElementById("cancelCreateFormBtn")
        .addEventListener("click", () => {
          document.getElementById("createTopic").value = "";
          document.getElementById("createTarget").value = "";
          document.getElementById("createStartDate").value = "";
          document.getElementById("createEndDate").value = "";
          document.getElementById("createDuration").value = "";
          createForm.classList.add("hidden");
        });

      // Fetch dropdown data for Programs, Nature of Staff, and Venues
      function fetchPrograms(isUpdate = false, selectedProgramId = null) {
        fetch("/api/programs/getall")
          .then((response) => response.json())
          .then((data) => {
            const programSelect = document.getElementById(
              isUpdate ? "updateProgram" : "createProgram"
            );
            programSelect.innerHTML = "";
            data.forEach((program) => {
              const option = document.createElement("option");
              option.value = program.programId;
              option.textContent = program.programName;
              if (isUpdate && program.programId === selectedProgramId) {
                option.selected = true;
              }
              programSelect.appendChild(option);
            });
          });
      }

      function fetchNatureOfStaff(
        isUpdate = false,
        selectedNatureOfStaffId = null
      ) {
        fetch("/api/natureofstaff/getall")
          .then((response) => response.json())
          .then((data) => {
            const natureSelect = document.getElementById(
              isUpdate ? "updateNatureOfStaff" : "createNatureOfStaff"
            );
            natureSelect.innerHTML = "";
            data.forEach((staff) => {
              const option = document.createElement("option");
              option.value = staff.natureOfStaffId;
              option.textContent = staff.natureOfStaffName;
              if (
                isUpdate &&
                staff.natureOfStaffId === selectedNatureOfStaffId
              ) {
                option.selected = true;
              }
              natureSelect.appendChild(option);
            });
          });
      }

      function fetchVenues(isUpdate = false, selectedVenueId = null) {
        fetch("/api/venues/getall")
          .then((response) => response.json())
          .then((data) => {
            const venueSelect = document.getElementById(
              isUpdate ? "updateVenue" : "createVenue"
            );
            venueSelect.innerHTML = "";
            data.forEach((venue) => {
              const option = document.createElement("option");
              option.value = venue.venueId;
              option.textContent = venue.venueName;
              if (isUpdate && venue.venueId === selectedVenueId) {
                option.selected = true;
              }
              venueSelect.appendChild(option);
            });
          });
      }

      // Initialize dropdowns and fetch calendars on page load
      window.onload = () => {
        fetchPrograms();
        fetchNatureOfStaff();
        fetchVenues();
        fetchCalendars();
      };

      // Fetch All Calendars
      function fetchCalendars() {
        fetch("/api/calander/all")
          .then((response) => response.json())
          .then((data) => {
            calendarList.innerHTML = "";
            data.forEach((calendar) => {
              const calendarItem = document.createElement("div");
              calendarItem.classList.add(
                "bg-gray-100",
                "p-4",
                "rounded",
                "flex",
                "justify-between",
                "items-center"
              );
              calendarItem.innerHTML = `
              <div class="text-gray-800">
                <strong>${calendar.topic}</strong><br>
                Program: ${calendar.programeName.programName}<br>
                Target: ${calendar.target}<br>
                Start: ${calendar.startDate}<br>
                End: ${calendar.endDate}<br>
                Venue: ${calendar.venueName.venueName}<br>
                Nature: ${calendar.natureOfStuffName.natureOfStaffName}<br>
              </div>
              <div class="flex space-x-3">
                <button class="bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600 transition" onclick="editCalendar(${calendar.calendarId}, '${calendar.topic}', '${calendar.target}', '${calendar.startDate}', '${calendar.endDate}', ${calendar.programeName.programId}, ${calendar.natureOfStuffName.natureOfStaffId}, ${calendar.venueName.venueId})">Update</button>
            
              </div>
            `;
              calendarList.appendChild(calendarItem);
            });
          });
      }
      // delete button
      // <button class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition" onclick="deleteCalendar(${calendar.calendarId})">Delete</button>

      // Create Calendar
      document
        .getElementById("createCalendarBtn")
        .addEventListener("click", () => {
          const topic = document.getElementById("createTopic").value;
          const target = document.getElementById("createTarget").value;
          const startDate = document.getElementById("createStartDate").value;
          const endDate = document.getElementById("createEndDate").value;
          const duration = document.getElementById("createDuration").value;
          const programId = document.getElementById("createProgram").value;
          const natureOfStaffId = document.getElementById(
            "createNatureOfStaff"
          ).value;
          const venueId = document.getElementById("createVenue").value;
          const calendar = {
            topic,
            target,
            startDate,
            endDate,
            duration,
            programId,
            natureOfStaffId,
            venueId,
          };
          fetch("/api/calander", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(calendar),
          })
            .then((response) => response.json())
            .then((data) => {
              fetchCalendars();
              createForm.classList.add("hidden");
            });
        });

      // Edit Calendar (populate update form)
      function editCalendar(
        id,
        topic,
        target,
        startDate,
        endDate,
        programId,
        natureOfStaffId,
        venueId
      ) {
        document.getElementById("updateCalendarId").value = id;
        document.getElementById("updateTopic").value = topic;
        document.getElementById("updateTarget").value = target;
        document.getElementById("updateStartDate").value = startDate;
        document.getElementById("updateEndDate").value = endDate;
        document.getElementById("updateDuration").value = ""; // Optionally, let the user recalculate duration

        // Pre-select dropdowns for update form
        fetchPrograms(true, programId);
        fetchNatureOfStaff(true, natureOfStaffId);
        fetchVenues(true, venueId);

        updateForm.classList.remove("hidden");
      }

      // Cancel Update Form
      document
        .getElementById("cancelUpdateFormBtn")
        .addEventListener("click", () => {
          updateForm.classList.add("hidden");
        });

      // Update Calendar
      document
        .getElementById("updateCalendarBtn")
        .addEventListener("click", () => {
          const calendarId = document.getElementById("updateCalendarId").value;
          const topic = document.getElementById("updateTopic").value;
          const target = document.getElementById("updateTarget").value;
          const startDate = document.getElementById("updateStartDate").value;
          const endDate = document.getElementById("updateEndDate").value;
          const duration = document.getElementById("updateDuration").value;
          const programId = document.getElementById("updateProgram").value;
          const natureOfStaffId = document.getElementById(
            "updateNatureOfStaff"
          ).value;
          const venueId = document.getElementById("updateVenue").value;
          const calendar = {
            calendarId,
            topic,
            target,
            startDate,
            endDate,
            duration,
            programId,
            natureOfStaffId,
            venueId,
          };

          fetch(`/api/calander/update`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(calendar),
          })
            .then((response) => response.json())
            .then((data) => {
              fetchCalendars();
              updateForm.classList.add("hidden");
            });
        });

      // Delete Calendar
      function deleteCalendar(calendarId) {
        if (confirm("Are you sure you want to delete this calendar?")) {
          fetch(`/api/calander/delete`, {
            method: "DELETE",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ calendarId }),
          })
            .then(() => {
              alert("Calendar entry deleted successfully!");
              fetchCalendars();
            })
            .catch(console.error);
        }
      }

      // Calculate duration based on start and end dates
      function calculateDuration(
        startDateInputId,
        endDateInputId,
        durationInputId
      ) {
        const startDateInput = document.getElementById(startDateInputId);
        const endDateInput = document.getElementById(endDateInputId);
        const durationInput = document.getElementById(durationInputId);

        if (startDateInput.value && endDateInput.value) {
          const startDate = new Date(startDateInput.value);
          const endDate = new Date(endDateInput.value);

          if (endDate >= startDate) {
            const durationInDays = Math.ceil(
              (endDate - startDate) / (1000 * 60 * 60 * 24)
            );
            durationInput.value = durationInDays;
          } else {
            alert("End date must be after start date.");
            durationInput.value = "";
          }
        } else {
          durationInput.value = "";
        }
      }

      // Attach event listeners to calculate duration for create and update forms
      document
        .getElementById("createStartDate")
        .addEventListener("change", () => {
          calculateDuration(
            "createStartDate",
            "createEndDate",
            "createDuration"
          );
        });
      document
        .getElementById("createEndDate")
        .addEventListener("change", () => {
          calculateDuration(
            "createStartDate",
            "createEndDate",
            "createDuration"
          );
        });
      document
        .getElementById("updateStartDate")
        .addEventListener("change", () => {
          calculateDuration(
            "updateStartDate",
            "updateEndDate",
            "updateDuration"
          );
        });
      document
        .getElementById("updateEndDate")
        .addEventListener("change", () => {
          calculateDuration(
            "updateStartDate",
            "updateEndDate",
            "updateDuration"
          );
        });
    </script>
  </body>
</html>
