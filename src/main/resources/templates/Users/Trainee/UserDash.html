<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layouts/default}"
>
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>User Dashboard</title>

    <!-- <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    /> -->
  </head>
  <main layout:fragment="content">
    <body>
      <div class="container my-5">
        <!-- Loading State -->
        <div id="loading" class="text-center py-5">
          <div
            class="spinner-border text-primary"
            style="width: 3rem; height: 3rem"
            role="status"
          >
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="text-muted mt-3">Loading dashboard...</p>
        </div>

        <!-- Main Content (hidden until loaded) -->
        <div id="content" class="d-none">
          <div class="mb-5 border-bottom pb-3">
            <h1 class="display-6">
              <i class="fas fa-calendar-alt me-2"></i>Training Programs
            </h1>
            <p class="text-muted">
              View and manage your assigned training programs
            </p>
          </div>

          <!-- Upcoming Programs -->
          <div class="card mb-4">
            <div class="card-header bg-info text-white">
              <h5 class="mb-0">
                <i class="fas fa-calendar-plus me-2"></i>Upcoming Programs
                <span id="upcomingCount" class="badge bg-white text-info ms-2"
                  >0</span
                >
              </h5>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>Program</th>
                      <th>Topic</th>
                      <th>Start Date</th>
                      <th>End Date</th>
                      <th>Duration</th>
                      <th>Venue</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody id="upcomingTableBody"></tbody>
                </table>
              </div>
              <div id="noUpcoming" class="text-center text-muted py-3 d-none">
                <i class="fas fa-info-circle me-2"></i>No upcoming training
                programs
              </div>
            </div>
          </div>

          <!-- Ongoing Programs -->
          <div class="card mb-4">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0">
                <i class="fas fa-spinner me-2"></i>Ongoing Programs
                <span id="ongoingCount" class="badge bg-white text-primary ms-2"
                  >0</span
                >
              </h5>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>Program</th>
                      <th>Topic</th>
                      <th>Start Date</th>
                      <th>End Date</th>
                      <th>Duration</th>
                      <th>Venue</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody id="ongoingTableBody"></tbody>
                </table>
              </div>
              <div id="noOngoing" class="text-center text-muted py-3 d-none">
                <i class="fas fa-info-circle me-2"></i>No ongoing training
                programs
              </div>
            </div>
          </div>

          <!-- Completed Programs -->
          <div class="card mb-4">
            <div class="card-header bg-success text-white">
              <h5 class="mb-0">
                <i class="fas fa-check-circle me-2"></i>Completed Programs
                <span
                  id="completedCount"
                  class="badge bg-white text-success ms-2"
                  >0</span
                >
              </h5>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>Program</th>
                      <th>Topic</th>
                      <th>Start Date</th>
                      <th>End Date</th>
                      <th>Duration</th>
                      <th>Venue</th>
                      <th>Status</th>
                      <th>Certificate</th>
                    </tr>
                  </thead>
                  <tbody id="completedTableBody"></tbody>
                </table>
              </div>
              <div id="noCompleted" class="text-center text-muted py-3 d-none">
                <i class="fas fa-info-circle me-2"></i>No completed training
                programs
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Certificate Modal -->
      <div
        class="modal fade"
        id="downloadModal"
        tabindex="-1"
        aria-labelledby="downloadModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-lg modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="downloadModalLabel">
                Certificate of Completion
              </h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body text-center">
              <h1 class="text-primary">Certificate of Completion</h1>
              <p class="lead">This is to certify that</p>
              <h2 id="GlobalUserFullName" class="my-4"></h2>
              <table
                class="table table-borderless mx-auto"
                style="max-width: 600px"
              >
                <tr>
                  <td><strong>Program Name:</strong></td>
                  <td><span id="programNameValue">N/A</span></td>
                </tr>
                <tr>
                  <td><strong>Topic:</strong></td>
                  <td><span id="topicValue">N/A</span></td>
                </tr>
                <tr>
                  <td><strong>Start Date:</strong></td>
                  <td><span id="startDateValue">N/A</span></td>
                </tr>
                <tr>
                  <td><strong>End Date:</strong></td>
                  <td><span id="endDateValue">N/A</span></td>
                </tr>
                <tr>
                  <td><strong>Venue:</strong></td>
                  <td><span id="venueValue">N/A</span></td>
                </tr>
              </table>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-primary" id="pdfGenerate">
                <i class="fas fa-download me-1"></i>Download Certificate
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Bootstrap Bundle (with Popper) -->
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
      <!-- jQuery -->
      <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
      <!-- jsPDF & html2canvas -->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

      <script>
        let GlobalUserFullName = "";
        let currentUserEmpCd = "";

        document.addEventListener("DOMContentLoaded", () => {
          initializeDashboard();
        });

        async function initializeDashboard() {
          // Show loader, hide content
          $("#loading").show();
          $("#content").addClass("d-none");

          // Fetch user info
          const userInfo = await fetch("/api/userinfo", {
            credentials: "include",
          }).then((r) => {
            if (!r.ok) throw new Error("Unauthorized");
            return r.json();
          });

          currentUserEmpCd = userInfo.empCd || "";
          GlobalUserFullName = userInfo.fullName || "";

          // Load calendars and then show content
          await loadTrainingCalendars();

          $("#loading").hide();
          $("#content").removeClass("d-none");
        }

        async function loadTrainingCalendars() {
          const resp = await fetch(
            `/api/assigntrainee/getByEmpCd/${currentUserEmpCd}`,
            { credentials: "include" }
          );
          if (!resp.ok) {
            console.error("Error fetching calendars");
            return;
          }
          const assignments = await resp.json();
          if (!assignments.length) {
            // Let the “noUpcoming/noOngoing/noCompleted” messages handle empty states
            renderCalendars([]);
          } else {
            renderCalendars(processCalendarData(assignments));
          }
        }

        function processCalendarData(data) {
          const today = new Date();
          today.setHours(0, 0, 0, 0);

          return data
            .map((a) => ({
              id: a.calendar?.calendarId || a.id,
              programName:
                a.calendar?.programeName?.programName ||
                a.calendar?.programName ||
                "Training Program",
              topic: a.calendar?.topicName || a.calendar?.topic || "General",
              venue: a.calendar?.venueName || a.calendar?.venue || "N/A",
              startDate: a.calendar?.startDate || a.calendar?.startDateTime,
              endDate: a.calendar?.endDate || a.calendar?.endDateTime,
              duration: a.calendar?.duration,
              status: a.status,
              materials: a.calendar?.materials || [],
              assignmentId: a.id,
            }))
            .sort((x, y) => new Date(x.startDate) - new Date(y.startDate));
        }

        function renderCalendars(calendars) {
          // Clear tables
          ["completed", "ongoing", "upcoming"].forEach((cat) => {
            $(`#${cat}TableBody`).empty();
            $(`#no${capitalize(cat)}`).addClass("d-none");
          });

          let counts = { upcoming: 0, ongoing: 0, completed: 0 };
          const today = new Date();
          today.setHours(0, 0, 0, 0);

          calendars.forEach((c) => {
            const sd = c.startDate ? new Date(c.startDate) : null;
            const ed = c.endDate ? new Date(c.endDate) : null;
            let status = c.status;
            if (sd && ed) {
              if (ed < today) status = "Completed";
              else if (sd <= today && today <= ed) status = "Ongoing";
              else status = "Upcoming";
            }

            const row = $("<tr></tr>");
            row.append(
              `<td><div class="fw-semibold">${c.programName}</div></td>`
            );
            row.append(`<td>${c.topic}</td>`);
            row.append(`<td>${formatDate(sd)}</td>`);
            row.append(`<td>${formatDate(ed)}</td>`);
            row.append(`<td>${c.duration ?? "N/A"}</td>`);
            row.append(`<td>${c.venue}</td>`);
            row.append(
              `<td><span class="badge bg-${badgeClass(
                status
              )}">${status}</span></td>`
            );

            if (status === "Completed") {
              const btn = $(
                `<button class="btn btn-sm btn-primary"><i class="fas fa-download me-1"></i>Certificate</button>`
              );
              btn.on("click", () => openModal(c));
              row.append($("<td></td>").append(btn));
              $("#completedTableBody").append(row);
              counts.completed++;
            } else if (status === "Ongoing") {
              $("#ongoingTableBody").append(row);
              counts.ongoing++;
            } else {
              $("#upcomingTableBody").append(row);
              counts.upcoming++;
            }
          });

          // Update badges & show empty states
          $("#upcomingCount").text(counts.upcoming);
          $("#ongoingCount").text(counts.ongoing);
          $("#completedCount").text(counts.completed);

          if (!counts.upcoming) $("#noUpcoming").removeClass("d-none");
          if (!counts.ongoing) $("#noOngoing").removeClass("d-none");
          if (!counts.completed) $("#noCompleted").removeClass("d-none");
        }

        function badgeClass(status) {
          return (
            {
              Upcoming: "info",
              Ongoing: "primary",
              Completed: "success",
            }[status] || "secondary"
          );
        }

        function formatDate(d) {
          if (!d) return "N/A";
          return d.toLocaleDateString("en-US", {
            year: "numeric",
            month: "short",
            day: "numeric",
          });
        }

        function capitalize(s) {
          return s.charAt(0).toUpperCase() + s.slice(1);
        }

        function openModal(calendar) {
          $("#GlobalUserFullName").text(GlobalUserFullName);
          $("#programNameValue").text(calendar.programName);
          $("#topicValue").text(calendar.topic);
          $("#startDateValue").text(formatDate(new Date(calendar.startDate)));
          $("#endDateValue").text(formatDate(new Date(calendar.endDate)));
          $("#venueValue").text(calendar.venue);
          new bootstrap.Modal($("#downloadModal")).show();
        }

        $("#pdfGenerate").on("click", () => {
          const modal = document.querySelector("#downloadModal .modal-content");
          html2canvas(modal).then((canvas) => {
            const img = canvas.toDataURL("image/png");
            const pdf = new jspdf.jsPDF();
            const imgProps = pdf.getImageProperties(img);
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
            pdf.addImage(img, "PNG", 0, 0, pdfWidth, pdfHeight);
            pdf.save(`${GlobalUserFullName}.pdf`);
          });
        });
      </script>
    </body>
  </main>
</html>
